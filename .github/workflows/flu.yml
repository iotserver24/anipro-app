name: Flutter Multi-Platform Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 2.26.6)'
        required: true
        type: string
        default: '2.26.6'
      build_number:
        description: 'Build number (e.g., 1)'
        required: true
        type: string
        default: '1'
      release_type:
        description: 'Release type (draft: testing, beta: beta version, latest: stable release)'
        required: true
        type: choice
        options:
          - draft
          - beta
          - latest
        default: 'draft'

env:
  FLUTTER_VERSION: 'stable'
  WORKING_DIRECTORY: 'flutter-test'

jobs:
  # Android builds - APK and AAB
  build-android:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Update app version in pubspec.yaml
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ“ Updating version in pubspec.yaml to ${{ inputs.version }}+${{ inputs.build_number }}"
          sed -i "s/^version: .*/version: ${{ inputs.version }}+${{ inputs.build_number }}/" pubspec.yaml
          echo "âœ… Updated version in pubspec.yaml"
          cat pubspec.yaml | grep "^version:"

      - name: Install Flutter dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ“¦ Installing Flutter dependencies..."
          flutter pub get
          echo "âœ… Dependencies installed"

      - name: Analyze Flutter code
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ” Analyzing Flutter code..."
          flutter analyze || echo "âš ï¸ Analysis completed with warnings"

      - name: Build Android APK
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ—ï¸ Building Android APK (release)..."
          flutter build apk --release
          echo "âœ… APK build complete"

      - name: Build Android App Bundle (AAB)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ—ï¸ Building Android App Bundle (release)..."
          flutter build appbundle --release
          echo "âœ… AAB build complete"

      - name: Rename Android artifacts
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          mkdir -p ../artifacts/android
          cp build/app/outputs/flutter-apk/app-release.apk ../artifacts/android/AniSurge-${{ inputs.version }}-android.apk
          cp build/app/outputs/bundle/release/app-release.aab ../artifacts/android/AniSurge-${{ inputs.version }}-android.aab
          echo "âœ… Android artifacts renamed and copied"
          ls -lh ../artifacts/android/

      - name: Upload Android APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: artifacts/android/AniSurge-${{ inputs.version }}-android.apk
          retention-days: 30

      - name: Upload Android AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: artifacts/android/AniSurge-${{ inputs.version }}-android.aab
          retention-days: 30

  # Windows build
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Update app version in pubspec.yaml
        working-directory: ${{ env.WORKING_DIRECTORY }}
        shell: bash
        run: |
          echo "ðŸ“ Updating version in pubspec.yaml to ${{ inputs.version }}+${{ inputs.build_number }}"
          sed -i "s/^version: .*/version: ${{ inputs.version }}+${{ inputs.build_number }}/" pubspec.yaml
          echo "âœ… Updated version in pubspec.yaml"
          cat pubspec.yaml | grep "^version:"

      - name: Install Flutter dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ“¦ Installing Flutter dependencies..."
          flutter pub get
          echo "âœ… Dependencies installed"

      - name: Analyze Flutter code
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ” Analyzing Flutter code..."
          flutter analyze
        continue-on-error: true

      - name: Build Windows executable
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ—ï¸ Building Windows executable (release)..."
          flutter build windows --release
          echo "âœ… Windows build complete"

      - name: Create Windows portable package
        working-directory: ${{ env.WORKING_DIRECTORY }}
        shell: powershell
        run: |
          echo "ðŸ“¦ Creating Windows portable package..."
          New-Item -ItemType Directory -Force -Path ..\artifacts\windows
          $buildPath = "build\windows\x64\runner\Release"
          $zipName = "..\artifacts\windows\AniSurge-${{ inputs.version }}-windows-x64.zip"
          
          # Compress the Release folder
          Compress-Archive -Path "$buildPath\*" -DestinationPath $zipName -Force
          
          echo "âœ… Windows package created"
          Get-ChildItem ..\artifacts\windows

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: artifacts/windows/AniSurge-${{ inputs.version }}-windows-x64.zip
          retention-days: 30

  # Create GitHub Release
  create-release:
    needs: [build-android, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Display structure of downloaded files
        run: |
          echo "ðŸ“‚ Downloaded artifacts structure:"
          ls -R release-artifacts/

      - name: Determine release tag and prerelease status
        id: release_info
        run: |
          if [ "${{ inputs.release_type }}" == "draft" ]; then
            TAG_NAME="v${{ inputs.version }}-draft-${{ inputs.build_number }}"
            IS_DRAFT="true"
            IS_PRERELEASE="false"
            RELEASE_NAME="AniSurge Flutter v${{ inputs.version }} (Draft Build ${{ inputs.build_number }})"
          elif [ "${{ inputs.release_type }}" == "beta" ]; then
            TAG_NAME="v${{ inputs.version }}-beta.${{ inputs.build_number }}"
            IS_DRAFT="false"
            IS_PRERELEASE="true"
            RELEASE_NAME="AniSurge Flutter v${{ inputs.version }} Beta ${{ inputs.build_number }}"
          else
            TAG_NAME="v${{ inputs.version }}"
            IS_DRAFT="false"
            IS_PRERELEASE="false"
            RELEASE_NAME="AniSurge Flutter v${{ inputs.version }}"
          fi
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "is_draft=$IS_DRAFT" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          
          echo "ðŸ“‹ Release Information:"
          echo "  Tag: $TAG_NAME"
          echo "  Name: $RELEASE_NAME"
          echo "  Draft: $IS_DRAFT"
          echo "  Prerelease: $IS_PRERELEASE"

      - name: Generate release notes
        id: release_notes
        run: |
          cat << EOF > release_notes.md
          ## AniSurge Flutter - Multi-Platform Release
          
          ### ðŸ“¦ Version Information
          - **Version**: ${{ inputs.version }}
          - **Build Number**: ${{ inputs.build_number }}
          - **Release Type**: ${{ inputs.release_type }}
          - **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ### ðŸ“± Supported Platforms
          - **Android**: APK and AAB (Android 5.0+, API 21+)
          - **Windows**: x64 Desktop (Windows 10+)
          
          ### ðŸŽ¯ Features
          - Browse trending, popular, and new anime releases
          - Search for your favorite anime
          - Stream anime episodes with built-in video player
          - Firebase authentication with Google Sign-In
          - Dark mode support
          - Material Design 3 UI
          
          ### ðŸ“¥ Download Instructions
          
          #### Android
          - **APK**: Download \`AniSurge-${{ inputs.version }}-android.apk\` for direct installation
          - **AAB**: For Google Play Store distribution (requires signing)
          
          #### Windows
          - **ZIP**: Download \`AniSurge-${{ inputs.version }}-windows-x64.zip\`
          - Extract the ZIP file and run \`anisurge.exe\`
          
          ### ðŸ”§ Installation
          
          **Android:**
          1. Download the APK file
          2. Enable "Install from Unknown Sources" in your device settings
          3. Open the APK file and follow the installation prompts
          
          **Windows:**
          1. Download the ZIP file
          2. Extract to your desired location
          3. Run \`anisurge.exe\` from the extracted folder
          
          ### âš ï¸ Notes
          - Android APK is signed with debug key for testing
          - First launch may take a few seconds to initialize
          - Internet connection required for streaming
          
          ---
          
          **API**: https://anisurge.me/api  
          **Firebase**: Configured and ready to use
          EOF
          
          echo "âœ… Release notes generated"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_info.outputs.tag_name }}
          name: ${{ steps.release_info.outputs.release_name }}
          body_path: release_notes.md
          draft: ${{ steps.release_info.outputs.is_draft }}
          prerelease: ${{ steps.release_info.outputs.is_prerelease }}
          files: |
            release-artifacts/android-apk/AniSurge-${{ inputs.version }}-android.apk
            release-artifacts/android-aab/AniSurge-${{ inputs.version }}-android.aab
            release-artifacts/windows-x64/AniSurge-${{ inputs.version }}-windows-x64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "## ðŸŽ‰ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ steps.release_info.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Name**: ${{ steps.release_info.outputs.release_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Type**: ${{ inputs.release_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Draft**: ${{ steps.release_info.outputs.is_draft }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Prerelease**: ${{ steps.release_info.outputs.is_prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Android APK: \`AniSurge-${{ inputs.version }}-android.apk\`" >> $GITHUB_STEP_SUMMARY
          echo "- Android AAB: \`AniSurge-${{ inputs.version }}-android.aab\`" >> $GITHUB_STEP_SUMMARY
          echo "- Windows x64: \`AniSurge-${{ inputs.version }}-windows-x64.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.release_info.outputs.tag_name }})" >> $GITHUB_STEP_SUMMARY
